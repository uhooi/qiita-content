---
title: iOSã‚¢ãƒ—ãƒªé–‹ç™ºãŒæ—ã‚‹Makefileã®ã‚¿ã‚¹ã‚¯ä¸€è¦§(é–‹ç™ºãƒ»CI)
tags:
  - iOS
  - Makefile
private: false
updated_at: '2022-01-01T13:35:34+09:00'
id: 7b14b5ce413989c751c3
organization_url_name: null
slide: false
---
## ã¯ã˜ã‚ã«

iOSã‚¢ãƒ—ãƒªã®é–‹ç™ºã¨CIã«ä½¿ãˆã‚‹ `Makefile` ã®ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

CDã«ä½¿ãˆã‚‹ã‚¿ã‚¹ã‚¯ã‚‚è¼‰ã›ãŸã‹ã£ãŸã®ã§ã™ãŒã€æ–‡é‡ãŒå¤šããªã£ãŸã®ã§ã„ãšã‚Œåˆ¥è¨˜äº‹ã§ç´¹ä»‹ã—ãŸã„ã§ã™ã€‚

## ã€ŒMakefileã€ã¨ã¯ï¼Ÿ

`make` ã‚³ãƒãƒ³ãƒ‰ã§ä½¿ã‚ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
`make` ã¯ã€æœ¬æ¥ã¯Cè¨€èªãªã©ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚„ãƒªãƒ³ã‚¯ã«ä½¿ã‚ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚

ã—ã‹ã—ã€ `Makefile` ã«å®šç¾©ã—ãŸã‚¿ã‚¹ã‚¯ï¼ˆæœ¬æ¥ã¯ã€Œã‚¿ãƒ¼ã‚²ãƒƒãƒˆã€ã¨å‘¼ã°ã‚Œã‚‹ãŒã€æœ¬è¨˜äº‹ã§ã¯ä¾¿å®œä¸Šã€Œã‚¿ã‚¹ã‚¯ã€ã¨å‘¼ã¶ï¼‰ã‚’ `make {ã‚¿ã‚¹ã‚¯å}` ã¨ã—ã¦å®Ÿè¡Œã§ãã‚‹ãŸã‚ã€ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ã¨ã—ã¦ã‚‚ã‚ˆãä½¿ã‚ã‚Œã¾ã™ã€‚
Node.jsã®npmã‚’ä½¿ã£ãŸã“ã¨ãŒã‚ã‚‹æ–¹ã¯ã€ `package.json` ã® `scripts` ã¨åŒã˜å½¹å‰²ã¨è€ƒãˆã‚‹ã¨ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚

iOSã‚¢ãƒ—ãƒªé–‹ç™ºã«ã¯æ¨™æº–ã§ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ã‚’å®šç¾©ã™ã‚‹ä»•çµ„ã¿ãŒãªã„ãŸã‚ã€ `Makefile` ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã™ã€‚

## Makefileã¨ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®é•ã„

`Makefile` ã®ã‚¿ã‚¹ã‚¯ã¯ã€ã‚·ã‚§ãƒ«ã®ã‚³ãƒãƒ³ãƒ‰ã‚’1è¡Œãšã¤å®Ÿè¡Œã—ã¾ã™ã€‚
ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚‚å®Ÿç¾ã§ãã‚‹ã“ã¨ãŒå¤šã„ã®ã§ã€ãƒ¡ãƒªãƒƒãƒˆã¨ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### Makefileã®ãƒ¡ãƒªãƒƒãƒˆ

#### 1ãƒ•ã‚¡ã‚¤ãƒ«ã§æ¸ˆã‚€

ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯1ãƒ•ã‚¡ã‚¤ãƒ«1ã‚¿ã‚¹ã‚¯ã§ã™ãŒï¼ˆé•ã£ãŸã‚‰ã™ã¿ã¾ã›ã‚“ï¼‰ã€ `Makefile` ã¯1ãƒ•ã‚¡ã‚¤ãƒ«ã«è¤‡æ•°ã®ã‚¿ã‚¹ã‚¯ã‚’å®šç¾©ã§ãã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ•£ã‚‰ã°ã‚‰ãšã€åå‰ã‚‚ `Makefile` å›ºå®šãªã®ã§ã€ã‚¿ã‚¹ã‚¯ã‚’ã©ã“ã«å®šç¾©ã—ãŸã‹å¿˜ã‚Œã¥ã‚‰ã„ã§ã™ã€‚

#### åºƒãçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹

iOSã‚¢ãƒ—ãƒªé–‹ç™ºã§ã¯ã‚ã¾ã‚Šä½¿ã‚ã‚Œã¦ã„ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ä»–ã®è¨€èªã§ã¯æ˜”ã‹ã‚‰ã‚ˆãä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚
Wikipediaã«ã‚ˆã‚‹ã¨ã€ `make` ã‚³ãƒãƒ³ãƒ‰ã®åˆç‰ˆã¯1977å¹´ã§ã™ã€‚

ãã®ãŸã‚ã€ãƒªãƒã‚¸ãƒˆãƒªå†…ã« `Makefile` ãŒã‚ã‚‹ã¨ã€çŸ¥ã£ã¦ã„ã‚‹äººãªã‚‰ã€Œã“ã“ã«ã‚ã‚‹ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚Œã°ãƒ“ãƒ«ãƒ‰ãªã©ãŒã§ãã‚‹ã‚“ã ãªã€ã¨ã‚ã‹ã‚Šã¾ã™ã€‚

#### è£œå®ŒãŒåŠ¹ã

bashãªã©ã®ã‚·ã‚§ãƒ«ã§è¨­å®šã™ã‚Œã°è£œå®ŒãŒåŠ¹ããŸã‚ã€é »ç¹ã«å®Ÿè¡Œã™ã‚‹å‡¦ç†ã¯ `Makefile` ã®ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å®šç¾©ã™ã‚‹ã¨ã‹ã‚“ãŸã‚“ã«ä½•åº¦ã‚‚å®Ÿè¡Œã§ãã¾ã™ã€‚

è£œå®Œã®è¨­å®šæ–¹æ³•ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã”å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
[Homebrewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ã‚ªã‚¹ã‚¹ãƒ¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ - Qiita](https://qiita.com/uhooi/items/a2e19ff0af3449be91b1#bash-completionè£œå®Œå¼·åŒ–)

### Makefileã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

#### è¤‡é›‘ãªå‡¦ç†ãŒå®Ÿè¡Œã—ã¥ã‚‰ã„

ç§ã‚‚ã»ã¨ã‚“ã©ç†è§£ã—ã¦ã„ãªã„ã®ã§ã™ãŒã€ `Makefile` ã®ä»•æ§˜ã¯è¤‡é›‘ãªã®ã§ã€é›£ã—ã„ã“ã¨ã‚’ã‚„ã‚ã†ã¨ã™ã‚‹ã¨ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚
ã‚¿ã‚¹ã‚¯ãƒ©ãƒ³ãƒŠãƒ¼ã¨ã—ã¦ä½¿ã†å ´åˆã€å˜ç´”ãªå‡¦ç†ã®ã¿å®Ÿè¡Œã™ã‚‹ã®ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚
ã‚‚ã—è¤‡é›‘ãªå‡¦ç†ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆã€ã‚¿ã‚¹ã‚¯ã‹ã‚‰ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‘¼ã³å‡ºã™ã®ãŒã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## æœ¬è¨˜äº‹ã§èª¬æ˜ã—ãªã„ã“ã¨

### makeã‚³ãƒãƒ³ãƒ‰ã‚„Makefileã®è©³ç´°ãªä»•æ§˜

ãã‚‚ãã‚‚ç§ãŒæœ€ä½é™ã®çŸ¥è­˜ã—ã‹ãªã„ã®ã§èª¬æ˜ã§ãã¾ã›ã‚“ï½—

### å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç®¡ç†ãƒ„ãƒ¼ãƒ«ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ¦‚è¦ã‚„ä½¿ã„æ–¹

ç§ãŒä»¥å‰æ›¸ã„ãŸè¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

- [Bundler](https://qiita.com/uhooi/items/4abf8c282ae23a259e4f)
- [Mint](https://qiita.com/uhooi/items/6a41a623b13f6ef4ddf0)
- [CocoaPods](https://qiita.com/uhooi/items/1134b0f784028412cb83)
- [Carthage](https://qiita.com/uhooi/items/ba20a604182ef25f6d7a)
- [Generamba](https://qiita.com/uhooi/items/c216b83fe462c863ff92)
- [LicensePlist](https://qiita.com/uhooi/items/c9f91637430c10b8555a)
- [XcodeGen](https://qiita.com/uhooi/items/16a870eaae24b46103fb)
- [Slather](https://qiita.com/uhooi/items/e1e464777d2163286c59)

## ç’°å¢ƒ

- makeï¼šGNU Make 3.81
- Xcodeï¼š11.6 (11E708)
- Swiftï¼š5.2.4

## Makefileã®ã‚¿ã‚¹ã‚¯ä¸€è¦§

ç§ãŒiOSã‚¢ãƒ—ãƒªã®é–‹ç™ºã¨CIã§å®šç¾©ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’ã²ã¨ã¤ãšã¤ç´¹ä»‹ã—ã¾ã™ã€‚

### setup

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã©ã€é–‹ç™ºç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

ç§ã¯ã§ãã‚‹é™ã‚Š `make setup` ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã€ãƒ“ãƒ«ãƒ‰ã§ãã‚‹çŠ¶æ…‹ã¾ã§é–‹ç™ºç’°å¢ƒãŒå®Œæˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€åŸºæœ¬çš„ã«ã¯ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸæœ€åˆã®1å›ã®ã¿å®Ÿè¡Œã—ã¾ã™ã€‚

```make:Makefile
.PHONY: setup
setup: # Install dependencies and prepared development configuration
	$(MAKE) install-ruby
	$(MAKE) install-bundler
	$(MAKE) install-templates
	$(MAKE) download-firebase-sdk
	$(MAKE) install-mint
	$(MAKE) install-carthage
	$(MAKE) generate-licenses
```

`$(MAKE) {ã‚¿ã‚¹ã‚¯å}` ã§ä»–ã®ã‚¿ã‚¹ã‚¯ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚

`# {ã‚³ãƒ¡ãƒ³ãƒˆ}` ã§ã‚³ãƒ¡ãƒ³ãƒˆãŒæ›¸ã‘ã‚‹ã®ã§ã€ã‚¿ã‚¹ã‚¯ã®æ¦‚è¦ã‚’è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚

ã‚ˆãREADMEã«é–‹ç™ºç’°å¢ƒã®æ§‹ç¯‰æ‰‹é †ã‚’è¨˜è¼‰ã—ã¾ã™ãŒã€ `make setup` ãŒã‚ã‚‹ã¨æ‰‹é †æ›¸ãŒã‚¹ãƒƒã‚­ãƒªã—ã¾ã™ã€‚
<img width="880" alt="ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2020-07-23 21.07.29.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/138245/36e07086-18a7-c392-fde7-aab36114c533.png">

å‚è€ƒï¼šhttps://github.com/uhooi/UhooiPicBook#readme

### install-ruby

`.ruby-version` ã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Rubyã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

`make setup` ã«å«ã‚“ã§ã„ã‚‹ãŸã‚ã€åŸºæœ¬çš„ã«ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ æ™‚ã«ã—ã‹ç›´æ¥å‘¼ã³å‡ºã—ã¾ã›ã‚“ã€‚

```make:Makefile
.PHONY: install-ruby
install-ruby:
	cat .ruby-version | xargs rbenv install --skip-existing
```

### install-bundler

Bundlerã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

ã“ã¡ã‚‰ã‚‚ `make setup` ã«å«ã‚“ã§ã„ã‚‹ãŸã‚ã€åŸºæœ¬çš„ã«ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ æ™‚ã«ã—ã‹ç›´æ¥å‘¼ã³å‡ºã—ã¾ã›ã‚“ã€‚

```make:Makefile
.PHONY: install-bundler
install-bundler: # Install Bundler dependencies
	bundle config path vendor/bundle
	bundle install --without=documentation --jobs 4 --retry 3
```

CIæ™‚ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸã„ãŸã‚ã€ãƒ‘ã‚¹ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

### update-bundler

Bundlerã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ›´æ–°ã—ã¾ã™ã€‚

é »ç¹ã«ã¯å‘¼ã³å‡ºã—ã¾ã›ã‚“ãŒã€ã‚³ãƒãƒ³ãƒ‰ãŒå¤šå°‘é•·ã„ã®ã§å®šç¾©ã—ã¦ãŠãã¨ä¾¿åˆ©ã§ã™ã€‚

```make:Makefile
.PHONY: update-bundler
update-bundler: # Update Bundler dependencies
	bundle config path vendor/bundle
	bundle update --jobs 4 --retry 3
```

### install-mint

Mintã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

ã“ã¡ã‚‰ã‚‚ `make setup` ã«å«ã‚“ã§ã„ã‚‹ãŸã‚ã€åŸºæœ¬çš„ã«ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ æ™‚ã«ã—ã‹ç›´æ¥å‘¼ã³å‡ºã—ã¾ã›ã‚“ã€‚

```make:Makefile
.PHONY: install-mint
install-mint: # Install Mint dependencies
	mint bootstrap --overwrite y
```

### install-cocoapods

CocoaPodsã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

å¾Œè¿°ã™ã‚‹å…¨ä½“å›³ã‚’è¿½ã†ã¨ã‚ã‹ã‚Šã¾ã™ãŒã€ `make setup` ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€ã“ã¡ã‚‰ã‚‚åŸºæœ¬çš„ã«ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ æ™‚ã«ã—ã‹ç›´æ¥å‘¼ã³å‡ºã—ã¾ã›ã‚“ã€‚

```make:Makefile
.PHONY: install-cocoapods
install-cocoapods: # Install CocoaPods dependencies and generate workspace
	bundle exec pod install
```

ç§ã¯CocoaPodsã‚’Bundlerã§ç®¡ç†ã—ã¦ã„ã‚‹ãŸã‚ã€å…ˆé ­ã« `bundle exec` ã‚’ä»˜ã‘ã¦å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
`Makefile` ã®ä½œæˆå‰ã¯ã‚ˆãä»˜ã‘å¿˜ã‚Œã¦ã„ãŸã®ã§ã€çŸ­ã„å‡¦ç†ã§ã‚‚ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å®šç¾©ã™ã‚‹ã¨å¿˜ã‚Œã¾ã›ã‚“ã€‚

### update-cocoapods

CocoaPodsã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ›´æ–°ã—ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```make:Makefile
.PHONY: update-cocoapods
update-cocoapods: # Update CocoaPods dependencies and generate workspace
	bundle exec pod update
```

### install-carthage

Carthageã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

ã“ã¡ã‚‰ã‚‚ `make setup` ã«å«ã‚“ã§ã„ã‚‹ãŸã‚ã€åŸºæœ¬çš„ã«ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ æ™‚ã«ã—ã‹ç›´æ¥å‘¼ã³å‡ºã—ã¾ã›ã‚“ã€‚

```make:Makefile
.PHONY: install-carthage
install-carthage: # Install Carthage dependencies
	mint run carthage carthage bootstrap --platform iOS --cache-builds
	@$(MAKE) show-carthage-dependencies
```

ç§ã¯Carthageã‚’Mintã§ç®¡ç†ã—ã¦ã„ã‚‹ãŸã‚ã€å…ˆé ­ã« `mint run carthage` ã‚’ä»˜ã‘ã¦å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

`@$(MAKE) show-carthage-dependencies` ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚

### update-carthage

Carthageã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ›´æ–°ã—ã¾ã™ã€‚

```make:Makefile
.PHONY: update-carthage
update-carthage: # Update Carthage dependencies
	mint run carthage carthage update --platform iOS
	@$(MAKE) show-carthage-dependencies
```

### show-carthage-dependencies

Carthageã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```make:Makefile
.PHONY: show-carthage-dependencies
show-carthage-dependencies:
	@echo '*** Resolved dependencies:'
	@cat 'Cartfile.resolved'
```

ç›´æ¥å‘¼ã³å‡ºã™ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ãªã„ã®ã§ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨˜è¿°ã—ã¦ã„ã¾ã›ã‚“ã€‚

Azure Pipelinesã«ã‚ã‚‹Carthageã®ã‚¿ã‚¹ã‚¯ã§ä½¿ã‚ã‚Œã¦ã„ã¦ã€æµç”¨ã•ã›ã¦ã„ãŸã ã„ã¦ã„ã¾ã™ã€‚

### install-templates

Generambaã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

`make setup` ã«å«ã‚“ã§ã„ã‚‹ãŸã‚ã€åŸºæœ¬çš„ã«ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¿½åŠ ã‚„å¤‰æ›´æ™‚ã«ã—ã‹ç›´æ¥å‘¼ã³å‡ºã—ã¾ã›ã‚“ã€‚

```make:Makefile
.PHONY: install-templates
install-templates: # Install Generamba templates
	bundle exec generamba template install
```

### download-firebase-sdk

Firebaseã®SDKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

ã“ã¡ã‚‰ã‚‚ `make setup` ã«å«ã‚“ã§ã„ã‚‹ãŸã‚ã€åŸºæœ¬çš„ã«ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¿½åŠ æ™‚ã«ã—ã‹ç›´æ¥å‘¼ã³å‡ºã—ã¾ã›ã‚“ã€‚

```make:Makefile
FIREBASE_VERSION := 8.6.0

.PHONY: download-firebase-sdk
download-firebase-sdk: # Download firebase-ios-sdk
	curl -OL https://github.com/firebase/firebase-ios-sdk/releases/download/${FIREBASE_VERSION}/Firebase.zip
	unzip -o Firebase.zip -d Frameworks/
	rm -f Firebase.zip
```

SwiftPMãªã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ã§ç®¡ç†ã™ã‚‹ã¨ãƒ“ãƒ«ãƒ‰ãŒéå¸¸ã«é…ããªã‚‹ãŸã‚ã€ç§ã¯æ‰‹å‹•ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å…¥ã‚Œã¦ã„ã¾ã™ã€‚

ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒç™ºç”Ÿã™ã‚‹ã®ã§ã€ `curl` ã‚³ãƒãƒ³ãƒ‰ã«ã¯ `-L` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### generate-licenses

LicensePlistã‚’ä½¿ã£ã¦ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±ã‚’ç”Ÿæˆã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ç›´ã—ã¾ã™ã€‚

`PRODUCT_NAME` ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿œã˜ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```make:Makefile
PRODUCT_NAME := UhooiPicBook

.PHONY: generate-licenses
generate-licenses: # Generate licenses with LicensePlist and regenerate project
	mint run LicensePlist license-plist --output-path ${PRODUCT_NAME}/Settings.bundle --add-version-numbers
	$(MAKE) generate-xcodeproj
```

`$(MAKE) generate-xcodeproj` ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚

### generate-module

Generambaã‚’ä½¿ã£ã¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç”Ÿæˆã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ç›´ã—ã¾ã™ã€‚

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ `make generate-module MODULE_NAME=Foo` ã®ã‚ˆã†ã«å‘¼ã³å‡ºã—ã¾ã™ã€‚

```make:Makefile
MODULE_TEMPLATE_NAME ?= uhooi_viper

.PHONY: generate-module
generate-module: # Generate module with Generamba and regenerate project # MODULE_NAME=[module name]
	bundle exec generamba gen ${MODULE_NAME} ${MODULE_TEMPLATE_NAME}
	$(MAKE) generate-xcodeproj
```

ã©ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã†ã‹æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ç§ã¯è‡ªä½œã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã¿ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€ `Makefile` ã«ç›´æ¥è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚

### generate-xcodeproj

XcodeGenã‚’ä½¿ã£ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã€CocoaPodsã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã€Xcodeã§é–‹ãã¾ã™ã€‚

```make:Makefile
.PHONY: generate-xcodeproj
generate-xcodeproj: # Generate project with XcodeGen
	mint run xcodegen xcodegen generate
	$(MAKE) install-cocoapods
	$(MAKE) open
```

Xcodeä»¥å¤–ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã‚„å¤‰æ›´ã—ãŸå ´åˆã€XcodeGenã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ç›´ã™å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ `make generate-licenses` ã‚„ `make generate-module` ã§ã‚‚å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ç›´ã—ãŸå ´åˆã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚‚ç”Ÿæˆã—ç›´ã™å¿…è¦ãŒã‚ã‚‹ãŸã‚ï¼ˆé•ã£ãŸã‚‰ã™ã¿ã¾ã›ã‚“ï¼‰ã€ `$(MAKE) install-cocoapods` ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

`$(MAKE) open` ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚

### open

ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’Xcodeã§é–‹ãã¾ã™ã€‚

`make open` ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§å¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒXcodeã§é–‹ãã®ã¯åœ°å‘³ã«ä¾¿åˆ©ã§ã™ã€‚
ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰Xcodeã¸ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«ç§»å‹•ã§ãã¾ã™ã€‚

```make:Makefile
PRODUCT_NAME := UhooiPicBook
WORKSPACE_NAME := ${PRODUCT_NAME}.xcworkspace

.PHONY: open
open: # Open workspace in Xcode
	open ./${WORKSPACE_NAME}
```

ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ã£ã¦ã„ãªã„å ´åˆã€æ‹¡å¼µå­ã‚’ `.xcodeproj` ã«å¤‰ãˆã¦ãã ã•ã„ã€‚

### clean

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ã—ã¾ã™ã€‚

ä»¥ä¸‹ã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã€Generambaã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã€‚

- CocoaPods
- Carthage
- Bundler

Xcodeã®ã‚¯ãƒªãƒ¼ãƒ³ã‚‚è¡Œã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ãŸã¾ã«å¤±æ•—ã—ã¦ãã‚Œä»¥é™ã®ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€æœ€å¾Œã«å®Ÿè¡Œã™ã‚‹ã®ãŒã„ã„ã§ã™ã€‚

```make:Makefile
.PHONY: clean
clean: # Delete cache
	rm -rf ./Pods
	rm -rf ./Carthage
	rm -rf ./vendor/bundle
	rm -rf ./Templates
	xcodebuild clean -alltargets
```

ä»–ã«ã‚‚å‰Šé™¤ã§ãã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ã„ã‚ã„ã‚ã‚ã‚‹ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã‚„å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

### analyze

SwiftLintã§ã‚¢ãƒŠãƒ©ã‚¤ã‚ºã—ã¾ã™ã€‚

è©³ç´°ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚
[SwiftLintã®Analyzeã‚’ä½¿ã£ã¦é«˜åº¦ãªè§£æã‚’ã™ã‚‹æ–¹æ³• - Qiita](https://qiita.com/uhooi/items/655655f56be8bd94b06d)

```make:Makefile
.PHONY: analyze
analyze: # Analyze with SwiftLint
	$(MAKE) build-debug
	mint run swiftlint swiftlint analyze --autocorrect --compiler-log-path ./${XCODEBUILD_BUILD_LOG_NAME}
```

### build-debug

ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

```make:Makefile
PRODUCT_NAME := UhooiPicBook
WORKSPACE_NAME := ${PRODUCT_NAME}.xcworkspace
SCHEME_NAME := ${PRODUCT_NAME}

TEST_SDK := iphonesimulator
TEST_CONFIGURATION := Debug

XCODEBUILD_BUILD_LOG_NAME := xcodebuild_build.log

.PHONY: build-debug
build-debug: # Xcode build for debug
	set -o pipefail \
&& xcodebuild \
-sdk ${TEST_SDK} \
-configuration ${TEST_CONFIGURATION} \
-workspace ${WORKSPACE_NAME} \
-scheme ${SCHEME_NAME} \
-destination ${TEST_DESTINATION} \
build \
| tee ./${XCODEBUILD_BUILD_LOG_NAME} \
| bundle exec xcpretty --color
```

å‡¦ç†ã®æœ«å°¾ã« `\` ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§æ”¹è¡Œã§ãã¾ã™ã€‚æ”¹è¡Œã¯ä»»æ„ã§ã™ãŒã€å¯èª­æ€§ã®ãŸã‚ã«å…¥ã‚Œã¦ã„ã¾ã™ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯å°‘ãªã„ã§ã™ãŒã€CIã§ã¯é »ç¹ã«å®Ÿè¡Œã—ã¾ã™ã€‚

`xcpretty` ã§ãƒ­ã‚°ã‚’è¦‹ã‚„ã™ãæ•´å½¢ã—ã¦ã„ã¾ã™ãŒã€ç”Ÿã®ãƒ­ã‚°ã‚ˆã‚Šæƒ…å ±é‡ãŒæ¸›ã‚‹ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚
ãã®ãŸã‚ã€ `tee` ã‚³ãƒãƒ³ãƒ‰ã§ç”Ÿã®ãƒ­ã‚°ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã—ã¦ã„ã¾ã™ã€‚
CIã§ã¯å¤±æ•—æ™‚ã®ã¿ç”Ÿã®ãƒ­ã‚°ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã®ãŒã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ã€‚

ç”Ÿã®ãƒ­ã‚°ã¯Gitã®ç®¡ç†å¤–ã«ã—ã¾ã™ã€‚

```diff:.gitignore
+ xcodebuild_*.log
```

### test

å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€çµæœã‚’HTMLã§å‡ºåŠ›ã—ã¾ã™ã€‚

ç§ã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®OSã¨ç«¯æœ«ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šã—ã¦å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
å¿…è¦ã«å¿œã˜ã¦OSã‚’æœªæŒ‡å®šã«å¤‰æ›´ã—ãŸã‚Šã€ç«¯æœ«ã‚„OSã‚’å¤‰æ•°ã§æ³¨å…¥ã—ãŸã‚Šã—ã¦ãã ã•ã„ã€‚

```make:Makefile
PRODUCT_NAME := UhooiPicBook
WORKSPACE_NAME := ${PRODUCT_NAME}.xcworkspace
SCHEME_NAME := ${PRODUCT_NAME}
UI_TESTS_TARGET_NAME := ${PRODUCT_NAME}UITests

TEST_SDK := iphonesimulator
TEST_CONFIGURATION := Debug
TEST_PLATFORM := iOS Simulator
TEST_DEVICE ?= iPhone 11 Pro Max
TEST_OS ?= 13.6
TEST_DESTINATION := 'platform=${TEST_PLATFORM},name=${TEST_DEVICE},OS=${TEST_OS}'

XCODEBUILD_TEST_LOG_NAME := xcodebuild_test.log

.PHONY: test
test: # Xcode test # TEST_DEVICE=[device] TEST_OS=[OS]
	set -o pipefail \
&& xcodebuild \
-sdk ${TEST_SDK} \
-configuration ${TEST_CONFIGURATION} \
-workspace ${WORKSPACE_NAME} \
-scheme ${SCHEME_NAME} \
-destination ${TEST_DESTINATION} \
-skip-testing:${UI_TESTS_TARGET_NAME} \
clean test \
| tee ./${XCODEBUILD_TEST_LOG_NAME} \
| bundle exec xcpretty --report html --color
```

UIãƒ†ã‚¹ãƒˆã¯CIã§é »ç¹ã«å®Ÿè¡Œã—ãŸããªã„ã®ã§ã€ `-skip-testing` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§UIãƒ†ã‚¹ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æŒ‡å®šã—ã¦ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã„ã¾ã™ã€‚

ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã¨åŒæ§˜ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯å°‘ãªã„ã§ã™ãŒã€CIã§ã¯é »ç¹ã«å®Ÿè¡Œã—ã¾ã™ã€‚

### get-coverage

Slatherã‚’ä½¿ã£ã¦ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’HTMLã§å‡ºåŠ›ã—ã¾ã™ã€‚

```make:Makefile
COVERAGE_OUTPUT := html_report

.PHONY: get-coverage
get-coverage: # Get code coverage
	bundle exec slather coverage --html --output-directory ${COVERAGE_OUTPUT}
```

### show-devices

æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ç«¯æœ«ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®ä¸€è¦§ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```make:Makefileï¼ˆXcode12æœªæº€ï¼‰
.PHONY: show-devices
show-devices: # Show devices
	instruments -s devices
```

CIæ™‚ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€å˜ä½“ãƒ†ã‚¹ãƒˆã§æŒ‡å®šã§ãã‚‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãŒã‚ã‹ã‚‹ã®ã§ä¾¿åˆ©ã§ã™ã€‚

Xcode 12ã‹ã‚‰ `instruments` ã‚³ãƒãƒ³ãƒ‰ãŒéæ¨å¥¨ã«ãªã‚Šã€ä»£ã‚ã‚Šã« `xcrun xctrace` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã„ã¾ã™ã€‚

```make:Makefileï¼ˆXcode12ä»¥é™ï¼‰
.PHONY: show-devices
show-devices: # Show devices
	xcrun xctrace list devices
```

Xcode 12ã§ `instruments` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```shell-session:Xcode12ã§instrumentã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨å‡ºåŠ›ã•ã‚Œã‚‹è­¦å‘Š
$ instruments -s devices
`instruments` is now deprecated in favor of 'xcrun xctrace' (see `man xctrace` for more information on its replacement)
```

### help

å„ã‚¿ã‚¹ã‚¯ã®ãƒ˜ãƒ«ãƒ—ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€å„ã‚¿ã‚¹ã‚¯ã¨ãã®ã™ãå³ã«è¨˜è¿°ã—ãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’å‡ºåŠ›ã—ã¾ã™ã€‚
ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨˜è¿°ã—ã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã¯å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“ã€‚

```make:Makefile
.DEFAULT_GOAL := help

.PHONY: help
help:
	@grep -E '^[a-zA-Z_-]+:.*?# .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":[^#]*? #| #"}; {printf "%-42s%s\n", $$1 $$3, $$2}'
```

`.DEFAULT_GOAL` ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€å˜ã« `make` ã¨å®Ÿè¡Œã—ãŸã¨ãã« `make help` ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

è©¦ã—ã«ä»Šã¾ã§ã®ã‚¿ã‚¹ã‚¯ã‚’è¨˜è¿°ã—ãŸ `Makefile` ã§ `make help` ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```shell-session:å‡ºåŠ›çµæœ
$ make help
setup                                      Install dependencies and prepared development configuration
install-bundler                            Install Bundler dependencies
update-bundler                             Update Bundler dependencies
install-mint                               Install Mint dependencies
install-cocoapods                          Install CocoaPods dependencies and generate workspace
update-cocoapods                           Update CocoaPods dependencies and generate workspace
install-carthage                           Install Carthage dependencies
update-carthage                            Update Carthage dependencies
install-templates                          Install Generamba templates
download-firebase-sdk                      Download firebase-ios-sdk
generate-licenses                          Generate licenses with LicensePlist and regenerate project
generate-module MODULE_NAME=[module name]  Generate module with Generamba and regenerate project
generate-xcodeproj                         Generate project with XcodeGen
open                                       Open workspace in Xcode
clean                                      Delete cache
analyze                                    Analyze with SwiftLint
build-debug                                Xcode build for debug
test TEST_DEVICE=[device] TEST_OS=[OS]     Xcode test
get-coverage                               Get code coverage
show-devices                               Show devices
```

ã“ã‚Œã§ `Makefile` ã«ã©ã®ã‚ˆã†ãªã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹ã‹ä¸€è¦§ã§å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã€ã‚¿ã‚¹ã‚¯åã‚’å¿˜ã‚Œã¦ã‚‚ `Makefile` ã®ä¸­èº«ã‚’ç¢ºèªã›ãšã«å®Ÿè¡Œã§ãã¾ã™ã€‚

## Makefileã®å…¨ä½“å›³

æœ€å¾Œã« `Makefile` ã®å…¨ä½“å›³ã‚’è¼‰ã›ã¾ã™ã€‚

å¤‰æ•°ã‚’ã¾ã¨ã‚ã¦å…ˆé ­ã«å®šç¾©ã™ã‚‹ã“ã¨ã§ã€ä»–ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã‚³ãƒ”ãƒšã—ã¦ä½¿ã„å›ã™ã¨ãã«ã€å…ˆé ­ã ã‘ä¿®æ­£ã™ã‚Œã°ã„ã„ã®ã§å¤‰æ›´æ¼ã‚ŒãŒæ¸›ã‚Šã¾ã™ã€‚

```make:Makefile
# Variables

PRODUCT_NAME := UhooiPicBook
WORKSPACE_NAME := ${PRODUCT_NAME}.xcworkspace
SCHEME_NAME := ${PRODUCT_NAME}
UI_TESTS_TARGET_NAME := ${PRODUCT_NAME}UITests

TEST_SDK := iphonesimulator
TEST_CONFIGURATION := Debug
TEST_PLATFORM := iOS Simulator
TEST_DEVICE ?= iPhone 11 Pro Max
TEST_OS ?= 13.6
TEST_DESTINATION := 'platform=${TEST_PLATFORM},name=${TEST_DEVICE},OS=${TEST_OS}'
COVERAGE_OUTPUT := html_report

XCODEBUILD_BUILD_LOG_NAME := xcodebuild_build.log
XCODEBUILD_TEST_LOG_NAME := xcodebuild_test.log

MODULE_TEMPLATE_NAME ?= uhooi_viper

FIREBASE_VERSION := 8.6.0

.DEFAULT_GOAL := help

# Targets

.PHONY: help
help:
	@grep -E '^[a-zA-Z_-]+:.*?# .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":[^#]*? #| #"}; {printf "%-42s%s\n", $$1 $$3, $$2}'

.PHONY: setup
setup: # Install dependencies and prepared development configuration
	$(MAKE) install-ruby
	$(MAKE) install-bundler
	$(MAKE) install-templates
	$(MAKE) download-firebase-sdk
	$(MAKE) install-mint
	$(MAKE) install-carthage
	$(MAKE) generate-licenses

.PHONY: install-bundler
install-bundler: # Install Bundler dependencies
	bundle config path vendor/bundle
	bundle install --without=documentation --jobs 4 --retry 3

.PHONY: update-bundler
update-bundler: # Update Bundler dependencies
	bundle config path vendor/bundle
	bundle update --jobs 4 --retry 3

.PHONY: install-mint
install-mint: # Install Mint dependencies
	mint bootstrap --overwrite y

.PHONY: install-cocoapods
install-cocoapods: # Install CocoaPods dependencies and generate workspace
	bundle exec pod install

.PHONY: update-cocoapods
update-cocoapods: # Update CocoaPods dependencies and generate workspace
	bundle exec pod update

.PHONY: install-carthage
install-carthage: # Install Carthage dependencies
	mint run carthage carthage bootstrap --platform iOS --cache-builds
	@$(MAKE) show-carthage-dependencies

.PHONY: update-carthage
update-carthage: # Update Carthage dependencies
	mint run carthage carthage update --platform iOS
	@$(MAKE) show-carthage-dependencies

.PHONY: show-carthage-dependencies
show-carthage-dependencies:
	@echo '*** Resolved dependencies:'
	@cat 'Cartfile.resolved'

.PHONY: install-templates
install-templates: # Install Generamba templates
	bundle exec generamba template install

.PHONY: download-firebase-sdk
download-firebase-sdk: # Download firebase-ios-sdk
	curl -OL https://github.com/firebase/firebase-ios-sdk/releases/download/${FIREBASE_VERSION}/Firebase.zip
	unzip -o Firebase.zip -d Frameworks/
	rm -f Firebase.zip

.PHONY: generate-licenses
generate-licenses: # Generate licenses with LicensePlist and regenerate project
	mint run LicensePlist license-plist --output-path ${PRODUCT_NAME}/Settings.bundle --add-version-numbers
	$(MAKE) generate-xcodeproj

.PHONY: generate-module
generate-module: # Generate module with Generamba and regenerate project # MODULE_NAME=[module name]
	bundle exec generamba gen ${MODULE_NAME} ${MODULE_TEMPLATE_NAME}
	$(MAKE) generate-xcodeproj

.PHONY: generate-xcodeproj
generate-xcodeproj: # Generate project with XcodeGen
	mint run xcodegen xcodegen generate
	$(MAKE) install-cocoapods
	$(MAKE) open

.PHONY: open
open: # Open workspace in Xcode
	open ./${WORKSPACE_NAME}

.PHONY: clean
clean: # Delete cache
	rm -rf ./Pods
	rm -rf ./Carthage
	rm -rf ./vendor/bundle
	rm -rf ./Templates
	xcodebuild clean -alltargets

.PHONY: analyze
analyze: # Analyze with SwiftLint
	$(MAKE) build-debug
	mint run swiftlint swiftlint analyze --autocorrect --compiler-log-path ./${XCODEBUILD_BUILD_LOG_NAME}

.PHONY: build-debug
build-debug: # Xcode build for debug
	set -o pipefail \
&& xcodebuild \
-sdk ${TEST_SDK} \
-configuration ${TEST_CONFIGURATION} \
-workspace ${WORKSPACE_NAME} \
-scheme ${SCHEME_NAME} \
-destination ${TEST_DESTINATION} \
build \
| tee ./${XCODEBUILD_BUILD_LOG_NAME} \
| bundle exec xcpretty --color

.PHONY: test
test: # Xcode test # TEST_DEVICE=[device] TEST_OS=[OS]
	set -o pipefail \
&& xcodebuild \
-sdk ${TEST_SDK} \
-configuration ${TEST_CONFIGURATION} \
-workspace ${WORKSPACE_NAME} \
-scheme ${SCHEME_NAME} \
-destination ${TEST_DESTINATION} \
-skip-testing:${UI_TESTS_TARGET_NAME} \
clean test \
| tee ./${XCODEBUILD_TEST_LOG_NAME} \
| bundle exec xcpretty --report html --color

.PHONY: get-coverage
get-coverage: # Get code coverage
	bundle exec slather coverage --html --output-directory ${COVERAGE_OUTPUT}

.PHONY: show-devices
show-devices: # Show devices
	instruments -s devices
```

## ãŠã‚ã‚Šã«

ã“ã“ã¾ã§ `Makefile` ã‚’ä½œã‚Šè¾¼ã‚€ã¨ã€Fastlaneã‚’ä½¿ã‚ãªãã¦ã‚‚iOSã‚¢ãƒ—ãƒªã®CIã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
CIã‚µãƒ¼ãƒ“ã‚¹ã‚’ç§»è¡Œã™ã‚‹å ´åˆã«ã‚‚ã€ `Makefile` ãŒã‚ã‚Œã°ã‚³ã‚¹ãƒˆã‚’æ¸›ã‚‰ã›ã¾ã™ã€‚

ãã—ã¦ä½•ã‚ˆã‚Šã€iOSã‚¢ãƒ—ãƒªã®CIç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ãªã„æ–¹ã®å‚è€ƒã«ãªã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚

## å‚è€ƒãƒªãƒ³ã‚¯

- [Top (GNU make)](https://www.gnu.org/software/make/manual/html_node/index.html)  
GNU Makeã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [make - Wikipedia](https://ja.wikipedia.org/wiki/Make)
- [Makefileã‚’è‡ªå·±æ–‡æ›¸åŒ–ã™ã‚‹ | POSTD](https://postd.cc/auto-documented-makefile/)
- [Makefile for iOS App development](https://gist.github.com/uhooi/f06f17a58973dc7834f0545cf87816e7)
- [Makefileã‚’åˆ©ç”¨ã—ã¦iOSé–‹ç™ºã‚’è³¢ãä¾¿åˆ©ã«é‹ç”¨ã—ã‚ˆã†ğŸ‰ - Qiita](https://qiita.com/YutoMizutani/items/6eea2ffac577ff481039)  
ç§ãŒiOSã‚¢ãƒ—ãƒªé–‹ç™ºã« `Makefile` ã‚’å°å…¥ã™ã‚‹ãã£ã‹ã‘ã¨ãªã£ãŸè¨˜äº‹ã§ã™
- [Makefile in iOS - Speaker Deck](https://speakerdeck.com/expensiveman/makefile-in-ios)
- [UhooiPicBook/Makefile at develop Â· uhooi/UhooiPicBook](https://github.com/uhooi/UhooiPicBook/blob/develop/Makefile)
- [UhooiPicBook/.gitignore at develop Â· uhooi/UhooiPicBook](https://github.com/uhooi/UhooiPicBook/blob/develop/.gitignore)
- https://twitter.com/the_uhooi/status/1305343192670199809?s=21
